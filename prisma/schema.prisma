generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["core", "payments", "events", "audit", "ops"]
}

/* ==================== ENUMS ==================== */

enum SettlementStatus {
  PENDING
  PAID
  SETTLED
  REJECTED
  REISSUED
  CANCELED
  CLAIMED_PAID
  @@schema("payments")
}

enum MerchantTier {
  TIER_1
  TIER_2
  TIER_3
  TIER_4
  TIER_5
  @@schema("core")
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  EXPIRED
  CANCELLED
  FAILED
  @@schema("payments")
}

/* ==================== CORE SCHEMA ==================== */

model SuperAdmin {
  id            String    @id @default(uuid()) @db.Uuid
  authUserId    String?   @unique @db.Uuid
  email         String    @unique @db.VarChar(255)
  name          String    @db.VarChar(100)
  currentPin    String?   @db.VarChar(60)
  pinExpiresAt  DateTime?
  pinAttempts   Int       @default(0)
  emailVerified Boolean   @default(false)
  suspendedAt   DateTime?
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
  @@index([suspendedAt])
  @@schema("core")
  @@map("super_admins")
}

model Merchant {
  id                          String       @id @default(uuid()) @db.Uuid
  slug                        String       @unique @db.VarChar(60)
  originalSlug                String?      @db.VarChar(60)
  authUserId                  String       @unique @db.Uuid
  email                       String       @unique @db.VarChar(255)
  businessName                String       @db.VarChar(100)
  defaultCurrency             String       @default("USD") @db.VarChar(3)
  timezone                    String       @default("UTC") @db.VarChar(50)
  maxBuyerOrdersPerHour       Int          @default(1)
  settleTolerancePct          Decimal      @default(2.0) @db.Decimal(5, 2)
  allowUnsolicitedPayments    Boolean      @default(true)
  paymentLinkMonthlyLimit     Int          @default(100)
  tier                        MerchantTier @default(TIER_1)
  walletLimit                 Int          @default(10)
  defaultPaymentExpiryMinutes Int          @default(60)
  currentPin                  String?      @db.VarChar(60)
  pinExpiresAt                DateTime?
  pinAttempts                 Int          @default(0)
  apiKeyHash                  String?      @unique @db.VarChar(64)
  apiKeyFingerprint           String?      @db.VarChar(20)
  apiKeyCreatedAt             DateTime?
  webhookSecret               String       @default(uuid()) @db.VarChar(64)
  emailVerified               Boolean      @default(false)
  phoneNumber                 String?      @db.VarChar(20)
  suspendedAt                 DateTime?
  suspendedBy                 String?      @db.Uuid
  suspendedReason             String?      @db.Text
  lastLoginAt                 DateTime?
  createdAt                   DateTime     @default(now())
  updatedAt                   DateTime     @updatedAt

  paymentRequests PaymentRequest[]
  wallets         Wallet[]
  paymentIntents  PaymentIntent[]
  webhooks        Webhook[]
  auditLogs       AuditLog[]

  @@index([slug])
  @@index([email])
  @@index([suspendedAt])
  @@index([emailVerified])
  @@index([tier])
  @@index([createdAt])
  @@schema("core")
  @@map("merchants")
}

model PluginRegistry {
  id            String    @id @default(uuid()) @db.Uuid
  pluginId      String    @unique @db.VarChar(50)
  baseUrl       String    @db.VarChar(255)
  secretHash    String    @db.Text
  enabled       Boolean   @default(true)
  allowedChains String[]
  lastSeenAt    DateTime?
  healthUrl     String?   @db.VarChar(255)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([enabled])
  @@index([pluginId])
  @@schema("core")
  @@map("plugin_registry")
}

/* ==================== PAYMENTS SCHEMA ==================== */

model PaymentRequest {
  id               String           @id @default(uuid()) @db.Uuid
  merchantId       String           @db.Uuid
  orderDate        String           @db.VarChar(8)
  orderNumber      Int
  linkId           String           @unique @db.VarChar(30)
  amountFiat       Decimal          @db.Decimal(18, 6)
  currencyFiat     String           @db.VarChar(3)
  description      String?          @db.Text
  expiryMinutes    Int              @default(60)
  expiresAt        DateTime
  createdBy        String           @db.VarChar(10)
  createdByIp      String?          @db.VarChar(45)
  buyerNote        String?          @db.Text
  status           PaymentStatus    @default(PENDING)
  settlementStatus SettlementStatus @default(PENDING)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  merchant       Merchant        @relation(fields: [merchantId], references: [id], onDelete: Restrict)
  paymentIntents PaymentIntent[]

  @@unique([merchantId, orderDate, orderNumber])
  @@index([linkId])
  @@index([merchantId, orderDate])
  @@index([status, expiresAt])
  @@index([createdAt])
  @@index([merchantId, status, expiresAt])
  @@index([settlementStatus])
  @@schema("payments")
  @@map("payment_requests")
}

model PaymentIntent {
  id                 String           @id @default(uuid()) @db.Uuid
  paymentRequestId   String           @db.Uuid
  merchantId         String           @db.Uuid
  pluginId           String           @db.VarChar(50)
  amountCrypto       Decimal          @db.Decimal(38, 18)
  amountFiat         Decimal          @db.Decimal(18, 6)
  selectedCoin       String           @db.VarChar(20)
  selectedChain      String           @db.VarChar(20)
  targetAddress      String?          @db.VarChar(255)
  targetMemo         String?          @db.VarChar(255)
  requiredConfs      Int?
  pluginIntentId     String?          @db.VarChar(255)
  status             PaymentStatus    @default(PENDING)
  settlementStatus   SettlementStatus @default(PENDING)
  amountReceived     Decimal?         @db.Decimal(38, 18)
  txId               String?          @db.VarChar(255)
  blockRef           Json?
  evidenceReceivedAt DateTime?
  settledAt          DateTime?
  expiresAt          DateTime
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  paymentRequest PaymentRequest @relation(fields: [paymentRequestId], references: [id], onDelete: Restrict)
  merchant       Merchant       @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([status, expiresAt])
  @@index([pluginId, status])
  @@index([txId])
  @@index([paymentRequestId])
  @@index([merchantId])
  @@index([settlementStatus])
  @@schema("payments")
  @@map("payment_intents")
}

model Wallet {
  id              String   @id @default(uuid()) @db.Uuid
  merchantId      String   @db.Uuid
  network         String   @db.VarChar(20)
  tokenSymbol     String   @db.VarChar(20)
  tokenName       String?  @db.VarChar(100)
  tokenType       String   @db.VarChar(20)
  tokenDecimals   Int      @default(9)
  contractAddress String?  @db.VarChar(255)
  walletAddress   String   @db.VarChar(255)
  label           String?  @db.VarChar(100)
  enabled         Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  merchant Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  @@unique([merchantId, network, tokenSymbol, walletAddress])
  @@index([merchantId, enabled])
  @@index([network, tokenSymbol])
  @@index([enabled])
  @@schema("payments")
  @@map("wallets")
}

/* ==================== EVENTS SCHEMA ==================== */

model Outbox {
  id            String    @id @default(uuid()) @db.Uuid
  eventType     String    @db.VarChar(60)
  aggregateId   String    @db.VarChar(64)
  payload       Json
  retryCount    Int       @default(0)
  maxRetries    Int       @default(5)
  lastAttemptAt DateTime?
  lastError     String?   @db.Text
  createdAt     DateTime  @default(now())
  dispatchedAt  DateTime?

  @@index([dispatchedAt, createdAt])
  @@index([eventType])
  @@index([aggregateId])
  @@schema("events")
  @@map("outbox")
}

model Webhook {
  id         String   @id @default(uuid()) @db.Uuid
  merchantId String   @db.Uuid
  url        String   @db.VarChar(500)
  events     String[]
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  merchant Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId, enabled])
  @@index([enabled])
  @@schema("events")
  @@map("webhooks")
}

/* ==================== AUDIT SCHEMA ==================== */

model AuditLog {
  id         String    @id @default(uuid()) @db.Uuid
  merchantId String?   @db.Uuid
  action     String    @db.VarChar(100)
  resourceId String?   @db.VarChar(64)
  payload    Json?
  ipAddress  String?   @db.VarChar(45)
  userAgent  String?   @db.VarChar(255)
  timestamp  DateTime  @default(now())

  merchant Merchant? @relation(fields: [merchantId], references: [id], onDelete: SetNull)

  @@index([merchantId, timestamp])
  @@index([timestamp])
  @@index([action])
  @@schema("audit")
  @@map("audit_logs")
}

/* ==================== OPS SCHEMA ==================== */

model AdvisoryLock {
  lockId    Int      @id @unique
  lockedAt  DateTime @default(now())
  lockedBy  String?  @db.VarChar(255)
  
  @@schema("ops")
  @@map("advisory_locks")
}
