generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

enum SettlementStatus {
  PENDING
  PAID
  SETTLED
  REJECTED
  REISSUED
  @@schema("payments")
}

enum MerchantTier {
  TIER_1
  TIER_2
  TIER_3
  TIER_4
  TIER_5
  @@schema("core")
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["core", "payments", "events", "audit", "ops"]
}

/* ==================== CORE SCHEMA ==================== */

model SuperAdmin {
  id           String    @id @default(uuid()) @db.Uuid
  email        String    @unique @db.VarChar(255)
  name         String    @db.VarChar(100)
  currentPin   String?   @db.VarChar(60)
  pinExpiresAt DateTime?
  pinAttempts  Int       @default(0)
  emailVerified Boolean   @default(false)
  suspendedAt   DateTime?
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@schema("core")
  @@map("super_admins")
}

model Merchant {
  id                       String    @id @default(uuid()) @db.Uuid
  slug                     String    @unique @db.VarChar(60)
  authUserId               String    @unique @db.Uuid
  email                    String    @unique @db.VarChar(255)
  businessName             String    @db.VarChar(100)
  defaultCurrency          String    @default("USD") @db.VarChar(3)
  timezone                 String    @default("UTC") @db.VarChar(50)
  maxBuyerOrdersPerHour    Int       @default(1)
  settleTolerancePct       Decimal   @default(2.0) @db.Decimal(5, 2)
  allowUnsolicitedPayments Boolean   @default(true)
  paymentLinkMonthlyLimit  Int       @default(100)
  tier                     MerchantTier @default(TIER_1)
  walletLimit              Int       @default(10)
  defaultPaymentExpiryMinutes Int   @default(60)
  currentPin               String?   @db.VarChar(60)
  pinExpiresAt             DateTime?
  pinAttempts              Int       @default(0)
  apiKeyHash               String?   @unique @db.VarChar(64)
  webhookSecret            String    @default(uuid()) @db.VarChar(64)
  emailVerified            Boolean   @default(false)
  suspendedAt              DateTime?
  suspendedBy              String?   @db.Uuid
  suspendedReason          String?   @db.Text
  lastLoginAt              DateTime?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  paymentRequests PaymentRequest[]
  wallets         Wallet[]
  paymentIntents  PaymentIntent[]
  webhooks        Webhook[]
  auditLogs       AuditLog[]

  @@index([slug])
  @@index([email])
  @@index([suspendedAt])
  @@index([emailVerified])
  @@schema("core")
  @@map("merchants")
}

model PluginRegistry {
  id            String    @id @default(uuid()) @db.Uuid
  pluginId      String    @unique @db.VarChar(50)
  baseUrl       String    @db.VarChar(255)
  secretHash    String    @db.Text
  enabled       Boolean   @default(true)
  allowedChains String[]
  lastSeenAt    DateTime?
  healthUrl     String?   @db.VarChar(255)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@schema("core")
  @@map("plugin_registry")
}

/* ==================== PAYMENTS SCHEMA ==================== */

model PaymentRequest {
  id           String    @id @default(uuid()) @db.Uuid
  merchantId   String    @db.Uuid
  orderDate    String    @db.VarChar(8)
  orderNumber  Int
  linkId       String    @unique @db.VarChar(30)
  amountFiat   Decimal   @db.Decimal(18, 6)
  currencyFiat String    @db.VarChar(3)
  description  String?   @db.Text
  expiryMinutes Int      @default(60)
  expiresAt     DateTime
  createdBy     String   @db.VarChar(10)
  createdByIp   String?  @db.VarChar(45)
  buyerNote     String?  @db.Text
  status       String    @default("PENDING") @db.VarChar(20)
  settlementStatus SettlementStatus @default(PENDING)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  merchant       Merchant        @relation(fields: [merchantId], references: [id], onDelete: Restrict)
  paymentIntents PaymentIntent[]

  @@unique([merchantId, orderDate, orderNumber])
  @@index([linkId])
  @@index([merchantId, orderDate])
  @@index([status, expiresAt])
  @@index([createdAt])
  @@index([merchantId, status, expiresAt])
  @@schema("payments")
  @@map("payment_requests")
}

model PaymentIntent {
  id                 String    @id @default(uuid()) @db.Uuid
  paymentRequestId   String    @db.Uuid
  merchantId         String    @db.Uuid
  pluginId           String    @db.VarChar(50)
  amountCrypto       Decimal   @db.Decimal(38, 18)
  amountFiat         Decimal   @db.Decimal(18, 6)
  selectedCoin       String    @db.VarChar(20)
  selectedChain      String    @db.VarChar(20)
  targetAddress      String?   @db.VarChar(255)
  targetMemo         String?   @db.VarChar(255)
  requiredConfs      Int?
  pluginIntentId     String?   @db.VarChar(255)
  status             String    @default("PENDING") @db.VarChar(20)
  settlementStatus SettlementStatus @default(PENDING)
  amountReceived     Decimal?  @db.Decimal(38, 18)
  txId               String?   @db.VarChar(255)
  blockRef           Json?
  evidenceReceivedAt DateTime?
  settledAt          DateTime?
  expiresAt          DateTime
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  paymentRequest PaymentRequest @relation(fields: [paymentRequestId], references: [id], onDelete: Restrict)
  merchant       Merchant       @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([status, expiresAt])
  @@index([pluginId, status])
  @@index([txId])
  @@schema("payments")
  @@map("payment_intents")
}

/* ==================== EVENTS SCHEMA ==================== */

model Outbox {
  id            String    @id @default(uuid()) @db.Uuid
  eventType     String    @db.VarChar(60)
  aggregateId   String    @db.VarChar(64)
  payload       Json
  retryCount    Int       @default(0)
  lastAttemptAt DateTime?
  lastError     String?   @db.Text
  createdAt     DateTime  @default(now())
  dispatchedAt  DateTime?

  @@index([dispatchedAt, createdAt])
  @@schema("events")
  @@map("outbox")
}

model Webhook {
  id         String   @id @default(uuid()) @db.Uuid
  merchantId String   @db.Uuid
  url        String   @db.VarChar(500)
  events     String[]
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  merchant Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@schema("events")
  @@map("webhooks")
}

/* ==================== AUDIT SCHEMA ==================== */

model AuditLog {
  id         String    @id @default(uuid()) @db.Uuid
  merchantId String?   @db.Uuid
  action     String    @db.VarChar(100)
  resourceId String?   @db.VarChar(64)
  payload    Json?
  timestamp  DateTime  @default(now())

  merchant Merchant? @relation(fields: [merchantId], references: [id], onDelete: SetNull)

  @@index([merchantId, timestamp])
  @@index([timestamp])
  @@schema("audit")
  @@map("audit_logs")
}

/* ==================== OPS SCHEMA ==================== */

model AdvisoryLock {
  lockId Int @id @unique
  
  @@schema("ops")
  @@map("advisory_locks")
}

/* ==================== UPDATED WALLET MODEL ==================== */

model Wallet {
  id              String   @id @default(uuid()) @db.Uuid
  merchantId      String   @db.Uuid
  merchant        Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  // Network Information
  network         String   @db.VarChar(20)        // SOLANA, ETHEREUM, BITCOIN, POLYGON, etc.
  
  // Token Information
  tokenSymbol     String   @db.VarChar(20)        // SOL, USDC, USDT, ETH, BTC, etc.
  tokenName       String?  @db.VarChar(100)       // "Solana", "USD Coin", "Tether USD"
  tokenType       String   @db.VarChar(20)        // NATIVE, SPL, ERC20, ERC721, BEP20, etc.
  tokenDecimals   Int      @default(9)            // 9 for SOL, 6 for USDC, 18 for ETH
  
  // Contract/Mint Address (null for native tokens like SOL, ETH, BTC)
  contractAddress String?  @db.VarChar(255)       // Token mint/contract address
  
  // Wallet Address
  walletAddress   String   @db.VarChar(255)       // The actual receiving address
  
  // Optional metadata
  label           String?  @db.VarChar(100)       // Custom label by merchant
  enabled         Boolean  @default(true)         // Active status
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([merchantId, network, tokenSymbol, walletAddress])
  @@index([merchantId, enabled])
  @@index([network, tokenSymbol])
  @@schema("payments")
  @@map("wallets")
}
